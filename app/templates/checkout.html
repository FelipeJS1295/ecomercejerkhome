{% extends "base.html" %}

{% block title %}Checkout - JerkHome{% endblock %}

{% block description %}Finaliza tu compra de muebles tapizados de alta calidad en JerkHome. Proceso de compra seguro y rápido.{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-secondary-gray py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-text-light mb-4">
                Finalizar Compra
            </h1>
            <p class="text-lg text-text-gray max-w-2xl mx-auto">
                Completa tu información para confirmar tu pedido
            </p>
            <div class="w-24 h-1 bg-gradient-to-r from-accent-orange to-accent-red mx-auto mt-6"></div>
        </div>
    </div>
</section>

<!-- Checkout Process -->
<section class="py-16 bg-primary-black">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Progress Steps -->
        <div class="mb-12">
            <div class="flex items-center justify-center space-x-4 md:space-x-8">
                <!-- Step 1: Cart -->
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-accent-orange rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                        </svg>
                    </div>
                    <span class="ml-2 text-accent-orange font-medium hidden md:block">Carrito</span>
                </div>
                
                <div class="w-8 h-0.5 bg-accent-orange"></div>
                
                <!-- Step 2: Checkout -->
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-accent-orange rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">2</span>
                    </div>
                    <span class="ml-2 text-accent-orange font-medium hidden md:block">Checkout</span>
                </div>
                
                <div class="w-8 h-0.5 bg-text-gray"></div>
                
                <!-- Step 3: Confirmation -->
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-text-gray rounded-full flex items-center justify-center">
                        <span class="text-primary-black font-bold text-sm">3</span>
                    </div>
                    <span class="ml-2 text-text-gray font-medium hidden md:block">Confirmación</span>
                </div>
            </div>
        </div>

        <!-- Main Checkout Content -->
        <div class="grid lg:grid-cols-2 gap-12">
            
            <!-- Left Column: Customer Information -->
            <div class="space-y-8">
                
                <!-- Contact Information -->
                <div class="bg-secondary-gray rounded-xl p-6 border border-border-gray">
                    <h2 class="text-2xl font-bold text-text-light mb-6 flex items-center">
                        <svg class="w-6 h-6 text-accent-orange mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Información de Contacto
                    </h2>
                    
                    <form id="contact-form" class="space-y-4">
                        <div>
                            <label class="block text-text-light font-medium mb-2" for="rut">
                                RUT *
                            </label>
                            <input type="text" id="rut" name="rut" required
                                   class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                   placeholder="12.345.678-9">
                            <div class="text-red-400 text-sm mt-1 hidden" id="rut-error"></div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-text-light font-medium mb-2" for="first-name">
                                    Nombre *
                                </label>
                                <input type="text" id="first-name" name="first-name" required
                                       class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                       placeholder="Tu nombre">
                            </div>
                            <div>
                                <label class="block text-text-light font-medium mb-2" for="last-name">
                                    Apellido *
                                </label>
                                <input type="text" id="last-name" name="last-name" required
                                       class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                       placeholder="Tu apellido">
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-text-light font-medium mb-2" for="email">
                                    Email *
                                </label>
                                <input type="email" id="email" name="email" required
                                       class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                       placeholder="tu@email.com">
                            </div>
                            <div>
                                <label class="block text-text-light font-medium mb-2" for="phone">
                                    Teléfono *
                                </label>
                                <input type="tel" id="phone" name="phone" required
                                       class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                       placeholder="+56 9 1234 5678">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Delivery Information -->
                <div class="bg-secondary-gray rounded-xl p-6 border border-border-gray">
                    <h2 class="text-2xl font-bold text-text-light mb-6 flex items-center">
                        <svg class="w-6 h-6 text-accent-orange mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Información de Entrega
                    </h2>
                    
                    <form id="delivery-form" class="space-y-4">
                        <div>
                            <label class="block text-text-light font-medium mb-2" for="address">
                                Dirección *
                            </label>
                            <input type="text" id="address" name="address" required
                                   class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                   placeholder="Av. Ejemplo 123, Depto 456">
                        </div>
                        
                        <div>
                            <label class="block text-text-light font-medium mb-2" for="region">
                                Región *
                            </label>
                            <select id="region" name="region" required
                                    class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light focus:border-accent-orange focus:outline-none transition-colors duration-300">
                                <option value="">Selecciona una región</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-text-light font-medium mb-2" for="comuna">
                                Comuna *
                            </label>
                            <select id="comuna" name="comuna" required disabled
                                    class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light focus:border-accent-orange focus:outline-none transition-colors duration-300 disabled:opacity-50">
                                <option value="">Primero selecciona una región</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-text-light font-medium mb-2" for="notes">
                                Notas de Entrega (Opcional)
                            </label>
                            <textarea id="notes" name="notes" rows="3"
                                      class="w-full px-4 py-3 bg-tertiary-gray border border-border-gray rounded-lg text-text-light placeholder-text-gray focus:border-accent-orange focus:outline-none transition-colors duration-300"
                                      placeholder="Instrucciones especiales, horarios preferidos, referencias de ubicación, etc."></textarea>
                        </div>
                        
                        <!-- Shipping Cost Display -->
                        <div id="shipping-info" class="bg-tertiary-gray rounded-lg p-4 border border-border-gray hidden">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-accent-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <p class="text-text-light font-medium">Costo de envío:</p>
                                    <p class="text-accent-orange font-semibold" id="shipping-cost">Calculando...</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Payment Method -->
                <div class="bg-secondary-gray rounded-xl p-6 border border-border-gray">
                    <h2 class="text-2xl font-bold text-text-light mb-6 flex items-center">
                        <svg class="w-6 h-6 text-accent-orange mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                        </svg>
                        Método de Pago
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border border-border-gray rounded-lg p-4 hover:border-accent-orange transition-colors duration-300">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="payment-method" value="webpay" class="text-accent-orange focus:ring-accent-orange" checked>
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    <div>
                                        <p class="text-text-light font-medium">Webpay Plus</p>
                                        <p class="text-text-gray text-sm">Pago inmediato con tarjeta de débito o crédito</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="border border-border-gray rounded-lg p-4 hover:border-accent-orange transition-colors duration-300">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="payment-method" value="transfer" class="text-accent-orange focus:ring-accent-orange">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6 text-accent-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                                    </svg>
                                    <div>
                                        <p class="text-text-light font-medium">Transferencia Bancaria</p>
                                        <p class="text-text-gray text-sm">Te enviaremos los datos bancarios por email</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="border border-border-gray rounded-lg p-4 hover:border-accent-orange transition-colors duration-300">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="payment-method" value="cash" class="text-accent-orange focus:ring-accent-orange">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6 text-accent-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    <div>
                                        <p class="text-text-light font-medium">Pago en Efectivo</p>
                                        <p class="text-text-gray text-sm">Pago contra entrega (solo Región Metropolitana)</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="lg:sticky lg:top-24 lg:self-start">
                <div class="bg-secondary-gray rounded-xl p-6 border border-border-gray">
                    <h2 class="text-2xl font-bold text-text-light mb-6 flex items-center">
                        <svg class="w-6 h-6 text-accent-orange mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Resumen del Pedido
                    </h2>
                    
                    <!-- Order Items -->
                    <div id="checkout-items" class="space-y-4 mb-6">
                        <!-- Items se cargarán aquí desde el carrito -->
                    </div>
                    
                    <!-- Empty state -->
                    <div id="checkout-empty" class="text-center py-8 hidden">
                        <svg class="w-16 h-16 text-text-gray mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.1 5A2 2 0 007.83 20H16a2 2 0 001.97-1.757L20 13H7z"/>
                        </svg>
                        <p class="text-text-gray">No hay productos en tu carrito</p>
                        <a href="/productos" class="inline-block mt-4 px-6 py-2 bg-accent-orange text-white rounded-lg hover:bg-accent-red transition-colors duration-300">
                            Ver Productos
                        </a>
                    </div>
                    
                    <!-- Order Summary -->
                    <div id="order-summary" class="border-t border-border-gray pt-6">
                        <div class="space-y-3">
                            <div class="flex justify-between text-text-gray">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0</span>
                            </div>
                            <div class="flex justify-between text-text-gray">
                                <span>Envío:</span>
                                <span id="shipping">Calculando...</span>
                            </div>
                            <div class="border-t border-border-gray pt-3">
                                <div class="flex justify-between text-xl font-bold text-text-light">
                                    <span>Total:</span>
                                    <span id="total" class="text-accent-orange">$0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Place Order Button -->
                        <button id="place-order-btn" 
                                class="w-full mt-6 bg-gradient-to-r from-accent-orange to-accent-red text-white font-bold py-4 rounded-lg hover:shadow-lg hover:shadow-accent-orange/25 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                            <span class="flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Confirmar Pedido</span>
                            </span>
                        </button>
                        
                        <p class="text-text-gray text-sm text-center mt-4">
                            Al confirmar tu pedido aceptas nuestros 
                            <a href="/terminos" class="text-accent-orange hover:underline">términos y condiciones</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- JavaScript para Checkout -->
<script>
    // Datos completos de regiones y comunas de Chile
    const regionesYComunas = {
        "XV": {
            name: "Arica y Parinacota",
            comunas: ["Arica", "Camarones", "General Lagos", "Putre"]
        },
        "I": {
            name: "Tarapacá",
            comunas: ["Alto Hospicio", "Camiña", "Colchane", "Huara", "Iquique", "Pica", "Pozo Almonte"]
        },
        "II": {
            name: "Antofagasta",
            comunas: ["Antofagasta", "Calama", "María Elena", "Mejillones", "Ollagüe", "San Pedro de Atacama", "Sierra Gorda", "Taltal", "Tocopilla"]
        },
        "III": {
            name: "Atacama",
            comunas: ["Alto del Carmen", "Caldera", "Chañaral", "Copiapó", "Diego de Almagro", "Freirina", "Huasco", "Tierra Amarilla", "Vallenar"]
        },
        "IV": {
            name: "Coquimbo",
            comunas: ["Andacollo", "Canela", "Combarbalá", "Coquimbo", "Illapel", "La Higuera", "La Serena", "Los Vilos", "Monte Patria", "Ovalle", "Paihuano", "Punitaqui", "Río Hurtado", "Salamanca", "Vicuña"]
        },
        "V": {
            name: "Valparaíso",
            comunas: ["Algarrobo", "Cabildo", "Calera", "Calle Larga", "Cartagena", "Casablanca", "Catemu", "Concón", "El Quisco", "El Tabo", "Hijuelas", "Isla de Pascua", "Juan Fernández", "La Cruz", "La Ligua", "Limache", "Llaillay", "Los Andes", "Nogales", "Olmué", "Panquehue", "Papudo", "Petorca", "Puchuncaví", "Putaendo", "Quillota", "Quilpué", "Quintero", "Rinconada", "San Antonio", "San Esteban", "San Felipe", "Santa María", "Santo Domingo", "Valparaíso", "Villa Alemana", "Viña del Mar", "Zapallar"]
        },
        "RM": {
            name: "Región Metropolitana",
            comunas: ["Alhué", "Buin", "Calera de Tango", "Cerrillos", "Cerro Navia", "Colina", "Conchalí", "Curacaví", "El Bosque", "El Monte", "Estación Central", "Huechuraba", "Independencia", "Isla de Maipo", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Lampa", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "María Pinto", "Melipilla", "Ñuñoa", "Padre Hurtado", "Paine", "Pedro Aguirre Cerda", "Peñaflor", "Peñalolén", "Pirque", "Providencia", "Pudahuel", "Puente Alto", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Bernardo", "San Joaquín", "San José de Maipo", "San Miguel", "San Pedro", "San Ramón", "Santiago", "Talagante", "Tiltil", "Vitacura"]
        },
        "VI": {
            name: "O'Higgins",
            comunas: ["Chépica", "Chimbarongo", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "La Estrella", "Las Cabras", "Litueche", "Lolol", "Machalí", "Malloa", "Marchigüe", "Mostazal", "Nancagua", "Navidad", "Olivar", "Palmilla", "Paredones", "Peralillo", "Peumo", "Pichidegua", "Pichilemu", "Placilla", "Pumanque", "Quinta de Tilcoco", "Rancagua", "Rengo", "Requínoa", "San Fernando", "San Vicente", "Santa Cruz"]
        },
        "VII": {
            name: "Maule",
            comunas: ["Cauquenes", "Chanco", "Colbún", "Constitución", "Curepto", "Curicó", "Empedrado", "Hualañé", "Licantén", "Linares", "Longaví", "Maule", "Molina", "Parral", "Pelarco", "Pelluhue", "Pencahue", "Rauco", "Retiro", "Río Claro", "Romeral", "Sagrada Familia", "San Clemente", "San Javier", "San Rafael", "Talca", "Teno", "Vichuquén", "Villa Alegre", "Yerbas Buenas"]
        },
        "XVI": {
            name: "Ñuble",
            comunas: ["Bulnes", "Chillán", "Chillán Viejo", "Cobquecura", "Coelemu", "Coihueco", "El Carmen", "Ninhue", "Ñiquén", "Pemuco", "Pinto", "Portezuelo", "Quillón", "Quirihue", "Ránquil", "San Carlos", "San Fabián", "San Ignacio", "San Nicolás", "Treguaco", "Yungay"]
        },
        "VIII": {
            name: "Biobío",
            comunas: ["Alto Biobío", "Antuco", "Arauco", "Cabrero", "Cañete", "Chiguayante", "Concepción", "Contulmo", "Coronel", "Curanilahue", "Florida", "Hualpén", "Hualqui", "Laja", "Lebu", "Los Álamos", "Los Ángeles", "Lota", "Mulchén", "Nacimiento", "Negrete", "Penco", "Quilaco", "Quilleco", "San Pedro de la Paz", "San Rosendo", "Santa Bárbara", "Santa Juana", "Talcahuano", "Tirúa", "Tomé", "Tucapel", "Yumbel"]
        },
        "IX": {
            name: "Araucanía",
            comunas: ["Angol", "Carahue", "Cholchol", "Collipulli", "Cunco", "Curacautín", "Curarrehue", "Ercilla", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Lonquimay", "Los Sauces", "Lumaco", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufquén", "Pucón", "Purén", "Renaico", "Saavedra", "Temuco", "Teodoro Schmidt", "Toltén", "Traiguén", "Victoria", "Vilcún", "Villarrica"]
        },
        "XIV": {
            name: "Los Ríos",
            comunas: ["Corral", "Futrono", "La Unión", "Lago Ranco", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "Río Bueno", "Valdivia"]
        },
        "X": {
            name: "Los Lagos",
            comunas: ["Ancud", "Calbuco", "Castro", "Chaitén", "Chonchi", "Cochamó", "Curaco de Vélez", "Dalcahue", "Fresia", "Frutillar", "Futaleufú", "Hualaihué", "Llanquihue", "Los Muermos", "Maullín", "Osorno", "Palena", "Puerto Montt", "Puerto Octay", "Puerto Varas", "Puqueldón", "Purranque", "Puyehue", "Queilén", "Quellón", "Quemchi", "Quinchao", "Río Negro", "San Juan de la Costa", "San Pablo"]
        },
        "XI": {
            name: "Aysén",
            comunas: ["Aysén", "Chile Chico", "Cisnes", "Cochrane", "Coyhaique", "Guaitecas", "Lago Verde", "O'Higgins", "Río Ibáñez", "Tortel"]
        },
        "XII": {
            name: "Magallanes",
            comunas: ["Antártica", "Cabo de Hornos", "Laguna Blanca", "Natales", "Porvenir", "Primavera", "Punta Arenas", "Río Verde", "San Gregorio", "Timaukel", "Torres del Paine"]
        }
    };

    // Costos de envío por región (en CLP)
    const shippingCosts = {
        "RM": 0,        // Gratis en RM
        "V": 15000,     // Valparaíso
        "VI": 20000,    // O'Higgins
        "VII": 25000,   // Maule
        "VIII": 30000,  // Biobío
        "XVI": 28000,   // Ñuble
        "IX": 35000,    // Araucanía
        "XIV": 40000,   // Los Ríos
        "X": 45000,     // Los Lagos
        "IV": 30000,    // Coquimbo
        "III": 40000,   // Atacama
        "II": 50000,    // Antofagasta
        "I": 55000,     // Tarapacá
        "XV": 60000,    // Arica y Parinacota
        "XI": 70000,    // Aysén
        "XII": 80000    // Magallanes
    };

    class Checkout {
        constructor() {
            this.cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            this.selectedRegion = '';
            this.selectedComuna = '';
            this.shippingCost = 0;
            this.init();
        }
        
        init() {
            this.populateRegions();
            this.renderCheckoutItems();
            this.bindEvents();
            this.validateCart();
            this.initRutValidation();
        }
        
        populateRegions() {
            const regionSelect = document.getElementById('region');
            
            // Limpiar opciones existentes
            regionSelect.innerHTML = '<option value="">Selecciona una región</option>';
            
            // Agregar regiones
            Object.keys(regionesYComunas).forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${regionesYComunas[code].name}`;
                regionSelect.appendChild(option);
            });
        }
        
        populateComunas(regionCode) {
            const comunaSelect = document.getElementById('comuna');
            
            if (!regionCode) {
                comunaSelect.innerHTML = '<option value="">Primero selecciona una región</option>';
                comunaSelect.disabled = true;
                return;
            }
            
            const region = regionesYComunas[regionCode];
            comunaSelect.innerHTML = '<option value="">Selecciona una comuna</option>';
            
            region.comunas.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna.toLowerCase().replace(/\s+/g, '-');
                option.textContent = comuna;
                comunaSelect.appendChild(option);
            });
            
            comunaSelect.disabled = false;
        }
        
        updateShippingCost(regionCode) {
            this.shippingCost = shippingCosts[regionCode] || 0;
            
            const shippingElement = document.getElementById('shipping');
            const shippingInfo = document.getElementById('shipping-info');
            const shippingCostElement = document.getElementById('shipping-cost');
            
            if (this.shippingCost === 0) {
                shippingElement.textContent = 'Gratis';
                shippingCostElement.textContent = 'Gratis';
            } else {
                shippingElement.textContent = `${this.shippingCost.toLocaleString()}`;
                shippingCostElement.textContent = `${this.shippingCost.toLocaleString()}`;
            }
            
            shippingInfo.classList.remove('hidden');
            this.updateTotal();
            
            // Manejar pago en efectivo solo para RM
            this.updatePaymentMethods(regionCode);
        }
        
        updatePaymentMethods(regionCode) {
            const cashOption = document.querySelector('input[value="cash"]').closest('.border');
            const cashLabel = cashOption.querySelector('p:last-child');
            
            if (regionCode !== 'RM') {
                cashOption.classList.add('opacity-50', 'pointer-events-none');
                document.querySelector('input[value="cash"]').disabled = true;
                cashLabel.textContent = 'Pago contra entrega (solo Región Metropolitana)';
                
                // Si estaba seleccionado el efectivo, cambiar a Webpay
                if (document.querySelector('input[value="cash"]').checked) {
                    document.querySelector('input[value="webpay"]').checked = true;
                }
            } else {
                cashOption.classList.remove('opacity-50', 'pointer-events-none');
                document.querySelector('input[value="cash"]').disabled = false;
                cashLabel.textContent = 'Pago contra entrega';
            }
        }
        
        initRutValidation() {
            const rutInput = document.getElementById('rut');
            const rutError = document.getElementById('rut-error');
            
            rutInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9kK]/g, '');
                
                if (value.length > 1) {
                    const rut = value.slice(0, -1);
                    const dv = value.slice(-1);
                    value = rut.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
                }
                
                e.target.value = value;
                
                if (value.length >= 11) {
                    if (this.validateRut(value)) {
                        rutError.classList.add('hidden');
                        rutInput.classList.remove('border-red-500');
                        rutInput.classList.add('border-green-500');
                    } else {
                        rutError.textContent = 'RUT inválido';
                        rutError.classList.remove('hidden');
                        rutInput.classList.add('border-red-500');
                        rutInput.classList.remove('border-green-500');
                    }
                } else {
                    rutError.classList.add('hidden');
                    rutInput.classList.remove('border-red-500', 'border-green-500');
                }
            });
        }
        
        validateRut(rut) {
            const cleanRut = rut.replace(/[^0-9kK]/g, '');
            const rutNumber = cleanRut.slice(0, -1);
            const dv = cleanRut.slice(-1).toUpperCase();
            
            let sum = 0;
            let multiplier = 2;
            
            for (let i = rutNumber.length - 1; i >= 0; i--) {
                sum += parseInt(rutNumber[i]) * multiplier;
                multiplier = multiplier === 7 ? 2 : multiplier + 1;
            }
            
            const remainder = sum % 11;
            const calculatedDv = remainder < 2 ? remainder.toString() : remainder === 2 ? 'K' : (11 - remainder).toString();
            
            return dv === calculatedDv;
        }
        
        validateCart() {
            if (this.cartItems.length === 0) {
                document.getElementById('checkout-items').classList.add('hidden');
                document.getElementById('checkout-empty').classList.remove('hidden');
                document.getElementById('order-summary').classList.add('hidden');
                document.getElementById('place-order-btn').disabled = true;
            } else {
                document.getElementById('checkout-items').classList.remove('hidden');
                document.getElementById('checkout-empty').classList.add('hidden');
                document.getElementById('order-summary').classList.remove('hidden');
                document.getElementById('place-order-btn').disabled = false;
            }
        }
        
        renderCheckoutItems() {
            const container = document.getElementById('checkout-items');
            let subtotal = 0;
            
            container.innerHTML = this.cartItems.map(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                return `
                    <div class="flex items-center space-x-4 p-4 bg-tertiary-gray rounded-lg">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="text-text-light font-medium">${item.name}</h3>
                            <p class="text-text-gray text-sm">Cantidad: ${item.quantity}</p>
                            <p class="text-accent-orange font-semibold">${item.price.toLocaleString()} c/u</p>
                        </div>
                        <div class="text-right">
                            <p class="text-text-light font-bold">${itemTotal.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update subtotal
            document.getElementById('subtotal').textContent = `${subtotal.toLocaleString()}`;
            this.updateTotal();
        }
        
        updateTotal() {
            const subtotal = this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal + this.shippingCost;
            document.getElementById('total').textContent = `${total.toLocaleString()}`;
        }
        
        bindEvents() {
            // Region change
            document.getElementById('region').addEventListener('change', (e) => {
                this.selectedRegion = e.target.value;
                this.populateComunas(this.selectedRegion);
                
                if (this.selectedRegion) {
                    this.updateShippingCost(this.selectedRegion);
                } else {
                    document.getElementById('shipping-info').classList.add('hidden');
                    document.getElementById('shipping').textContent = 'Calculando...';
                    this.shippingCost = 0;
                    this.updateTotal();
                }
            });
            
            // Comuna change
            document.getElementById('comuna').addEventListener('change', (e) => {
                this.selectedComuna = e.target.value;
            });
            
            // Place order button
            document.getElementById('place-order-btn').addEventListener('click', () => this.placeOrder());
        }
        
        validateForm() {
            const requiredFields = [
                'rut', 'first-name', 'last-name', 'email', 'phone', 
                'address', 'region', 'comuna'
            ];
            
            let isValid = true;
            const errors = [];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500');
                    errors.push(`El campo ${field.previousElementSibling.textContent.replace('*', '').trim()} es requerido`);
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            // Validate email
            const email = document.getElementById('email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email.value && !emailRegex.test(email.value)) {
                isValid = false;
                email.classList.add('border-red-500');
                errors.push('Ingresa un email válido');
            }
            
            // Validate RUT
            const rut = document.getElementById('rut');
            if (rut.value && !this.validateRut(rut.value)) {
                isValid = false;
                errors.push('El RUT ingresado no es válido');
            }
            
            // Validate payment method
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            if (!paymentMethod) {
                isValid = false;
                errors.push('Selecciona un método de pago');
            }
            
            return { isValid, errors };
        }
        
        placeOrder() {
            const validation = this.validateForm();
            
            if (!validation.isValid) {
                this.showNotification('Por favor completa todos los campos requeridos correctamente', 'error');
                return;
            }
            
            if (this.cartItems.length === 0) {
                this.showNotification('Tu carrito está vacío', 'error');
                return;
            }
            
            // Collect form data
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            
            const orderData = {
                customer: {
                    rut: document.getElementById('rut').value,
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                },
                delivery: {
                    address: document.getElementById('address').value,
                    region: this.selectedRegion,
                    regionName: regionesYComunas[this.selectedRegion]?.name || '',
                    comuna: this.selectedComuna,
                    comunaName: document.getElementById('comuna').selectedOptions[0]?.text || '',
                    notes: document.getElementById('notes').value
                },
                payment: {
                    method: paymentMethod
                },
                items: this.cartItems,
                subtotal: this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                shippingCost: this.shippingCost,
                total: this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0) + this.shippingCost,
                timestamp: new Date().toISOString()
            };
            
            // Show loading state
            const btn = document.getElementById('place-order-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `
                <span class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Procesando...</span>
                </span>
            `;
            btn.disabled = true;
            
            // Simulate order processing
            setTimeout(async () => {
                try {
                    // Enviar pedido al servidor
                    const response = await fetch('/api/checkout/crear-pedido', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Clear cart
                        localStorage.removeItem('cart');
                        
                        // Show success message
                        this.showNotification('¡Pedido creado exitosamente!', 'success');
                        
                        // Redirect según el método de pago
                        setTimeout(() => {
                            window.location.href = result.redirect_url || '/confirmacion';
                        }, 1500);
                        
                    } else {
                        throw new Error(result.message || 'Error creando pedido');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    this.showNotification('Error procesando el pedido. Inténtalo nuevamente.', 'error');
                }
            }, 2000);
        }
        
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-accent-orange';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    }
    
    // Initialize checkout
    document.addEventListener('DOMContentLoaded', function() {
        new Checkout();
    });
</script>
{% endblock %}